<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Wƒôdliny z Druciarni ‚Äî Zam√≥wienia (Mobile v5)</title>
<meta name="theme-color" content="#0b0f1a">
<style>
  :root{
    --bg:#0b0f1a; --card:#111827; --muted:#9ca3af; --text:#e5e7eb; --accent:#fbbf24; --btn:#1f2937;
    --border:#1f2937; --tile:#0d1426; --tile-border:#1a2440;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:var(--bg); color:var(--text);
  }

  /* Topbar (HEADER) ‚Äî updated to support 3 graphics: left (wƒôdliny), center (logo), right (sztuƒáce) */
  .topbar{
    position:sticky; top:0; z-index:20;
    display:grid; grid-template-columns:1fr auto 1fr; align-items:center;
    padding:calc(6px + env(safe-area-inset-top)) 10px 6px;
    background:linear-gradient(180deg,rgba(11,15,26,.97),rgba(11,15,26,.88));
    backdrop-filter:saturate(180%) blur(8px);
    border-bottom:1px solid var(--border);
    gap:10px;
  }
  .hdr-img{
    max-height:clamp(36px,8vw,72px);
    width:auto; object-fit:contain; filter:drop-shadow(0 2px 4px rgba(0,0,0,.35));
    opacity:.95;
  }
  .hdr-img.left{ justify-self:start; }
  .hdr-img.right{ justify-self:end; transform:scaleX(-1); } /* opcjonalne lustrzane odbicie, usu≈Ñ je≈õli niepotrzebne */

  .logo-center{
    width:auto; height:auto; display:block;
    max-width:min(80vw, 820px);
    max-height:clamp(48px,10vw,120px);
    object-fit:contain;
    filter:drop-shadow(0 2px 4px rgba(0,0,0,.35));
    justify-self:center;
  }

  /* Gdy bardzo wƒÖsko ‚Äî chowamy boczne grafiki, zostawiamy tylko logo */
  @media (max-width:420px){
    .topbar{ grid-template-columns:1fr; }
    .hdr-img{ display:none; }
    .logo-center{ max-width:88vw; }
  }

  .title h1{margin:0; font-size:18px; letter-spacing:.2px}
  .title .tag{font-size:12px; color:var(--muted)}

  .content{padding:12px; display:grid; gap:12px; padding-bottom:24px}

  .card{
    background:var(--card); border:1px solid var(--border);
    border-radius:18px; padding:12px;
    box-shadow:0 8px 30px rgba(0,0,0,.25);
  }
  h3{margin:0 0 8px 0; font-size:16px}

  input,select,textarea,button{font:inherit}
  input,select,textarea{
    width:100%; padding:14px 14px; border-radius:14px;
    border:1px solid #243049; background:#0b1220; color:var(--text);
  }
  textarea{min-height:92px}

  /* Pills / small text */
  .muted{color:var(--muted); font-size:12px}
  .pill{display:inline-block; padding:6px 10px; border-radius:999px; background:#0b1220; border:1px solid #22304c; color:var(--muted); font-size:12px}

  /* Search */
  .search{position:relative}
  .search .icon{position:absolute; left:12px; top:50%; transform:translateY(-50%); opacity:.6}
  .search input{padding-left:40px; border-radius:16px}

  /* Product tile */
  .tile{
    background:var(--tile); border:1px solid var(--tile-border);
    border-radius:16px; padding:12px; display:grid; gap:10px;
    box-shadow:0 6px 18px rgba(0,0,0,.25);
  }
  .tile-head{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  .name{display:flex; align-items:center; gap:8px; font-weight:800; font-size:17px; color:var(--accent)}
  .price{font-size:14px; font-weight:800}
  .badge{
    display:inline-flex; align-items:center; gap:6px; padding:6px 10px;
    border-radius:999px; border:2px solid var(--accent); background:#1a1f2e;
    color:var(--accent); font-size:12px; font-weight:800; letter-spacing:.3px
  }
  .badge .dot{width:8px; height:8px; border-radius:50%; background:var(--accent)}

  .tile-body{display:grid; gap:10px}
  .row-grid{display:grid; grid-template-columns:1fr; gap:8px}
  @media (min-width:520px){ .row-grid{ grid-template-columns: 1fr 1fr } }

  /* Stepper */
  .stepper{
    display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:8px;
    background:#0b1220; border:1px solid #243049; border-radius:14px; padding:8px;
  }
  .stepper button{
    min-width:44px; min-height:44px; border-radius:12px; border:1px solid #2a3648; background:var(--btn);
    color:var(--text); cursor:pointer;
  }
  .stepper input{
    border:none; background:transparent; text-align:center; font-weight:700; font-size:16px; padding:8px 4px
  }

  /* Switch */
  .switch{ display:inline-flex; align-items:center; gap:10px; user-select:none; }
  .switch input{display:none}
  .switch .track{ width:52px; height:30px; background:#26324b; border:1px solid #2a3a5e; border-radius:999px; position:relative; transition:.2s; }
  .switch .thumb{ position:absolute; top:50%; transform:translateY(-50%); left:4px; width:24px; height:24px; background:#e5e7eb; border-radius:50%; transition:.2s; }
  .switch input:checked + .track{ background:#f59e0b; border-color:#f59e0b }
  .switch input:checked + .track .thumb{ left:24px; background:#111 }

  /* Summary */
  .summary{background:#0b1220; border:1px solid #23314e; border-radius:14px; padding:12px; white-space:pre-wrap}

  /* Actions (below summary) */
  .actions{display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:10px}
  @media (min-width:560px){ .actions{ grid-template-columns: repeat(6, 1fr) } }
  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    padding:14px 16px; border-radius:14px; border:1px solid #2a3648; background:var(--btn);
    color:var(--text); text-decoration:none; cursor:pointer; min-height:48px; font-weight:700;
  }
  .btn.primary{background:linear-gradient(180deg,#f59e0b,#f59e0b 60%,#d97706); color:#111; border-color:#f59e0b}
  .btn.ghost{background:transparent}

  /* Modal */
  .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:50}
  .modal{width:min(560px,92vw); background:var(--card); border:1px solid var(--border); border-radius:18px; padding:16px; box-shadow:0 20px 60px rgba(0,0,0,.55)}
  .modal h4{margin:0 0 10px 0; font-size:16px}
  .modal .grid{display:grid; gap:10px; grid-template-columns:1fr}
  @media (min-width:640px){ .modal .grid{ grid-template-columns:1fr 1fr } }
  .modal .actions{display:flex; gap:8px; justify-content:flex-end; margin-top:10px}
  .field-note{font-size:12px; color:var(--muted); margin-top:2px}
  .error{border-color:#dc2626!important; outline-color:#dc2626!important}

  /* Helpers */
  .mini{font-size:12px; color:var(--muted)}
</style>
</head>
<body>
  <!-- HEADER with three graphics -->
  <div class="topbar" role="banner" aria-label="Wƒôdliny z Druciarni">
    <!-- LEFT: wƒôdliny graphic -->
    <img src="header-wedliny.png" class="hdr-img left" alt="Grafika wƒôdlin po lewej" />
    <!-- CENTER: main logo wordmark -->
    <img src="logo-wedliny-z-druciarni.svg" class="logo-center" alt="Wƒôdliny z Druciarni ‚Äî logo" />
    <!-- RIGHT: cutlery graphic -->
    <img src="header-sztucce.png" class="hdr-img right" alt="Grafika sztuƒác√≥w po prawej" />
  </div>

  <div class="content">
    <!-- Klient -->
    <div class="card">
      <h3>Klient</h3>
      <div class="row-grid">
        <input id="cust-name" placeholder="Imiƒô i nazwisko" />
        <input id="cust-phone" placeholder="Telefon" inputmode="tel" />
        <input id="cust-email" placeholder="E-mail (opcjonalnie)" inputmode="email" />
        <input id="cust-date" type="date" placeholder="Data odbioru" />
      </div>
      <div style="margin-top:8px"><textarea id="cust-notes" placeholder="Uwagi do zam√≥wienia (np. grubo, ostro, przyprawy)"></textarea></div>
      <div class="mini" style="margin-top:6px;">
        Pakowanie pr√≥≈ºniowe mo≈ºliwe za dop≈ÇatƒÖ: <strong>1,50 z≈Ç</strong> / pozycjƒô.
        <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn" id="btn-pack-all">Zaznacz pakowanie dla wszystkich z ilo≈õciƒÖ</button>
          <button class="btn ghost" id="btn-pack-clear">Odznacz pakowanie wszƒôdzie</button>
        </div>
      </div>
    </div>

    <!-- Produkty -->
    <div class="card">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
        <h3>Produkty</h3>
        <div class="search" style="min-width:230px; flex:1">
          <span class="icon">üîé</span>
          <input id="search" placeholder="Szukaj produktu‚Ä¶" />
        </div>
      </div>
      <div class="mini" style="margin-top:6px;">
        Mini cennik: Szynka/Karczek/Schab/Boczek <b>47 z≈Ç/kg</b> ¬∑
        Kie≈Çbasa bia≈Ça <b>35 z≈Ç/kg</b> ¬∑ Kie≈Çbasa wƒôdzona <b>37 z≈Ç/kg</b> ¬∑
        Polƒôdwiczka <b>25 z≈Ç/szt</b> ¬∑ Pasztet <b>20 z≈Ç/szt</b> ¬∑ Salceson <b>35 z≈Ç/kg</b> ¬∑
        Serki (bez przypraw / czarnuszka / pomidory-bazylia / czosnek / curry / chilli) <b>10 z≈Ç/szt</b> ¬∑
        Makrela <b>22 z≈Ç/szt</b> ¬∑ ≈öled≈∫ <b>20 z≈Ç/szt</b> ¬∑ ≈Åoso≈õ <b>55 z≈Ç/kg</b> ¬∑ Krupniok <b>18 z≈Ç/kg</b> ¬∑
        <b>Indyk</b> <b>55 z≈Ç/kg</b>.
      </div>
      <div id="product-list" style="display:grid; gap:10px; margin-top:10px;"></div>

      <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap; margin-top:12px;">
        <span class="pill">Ilo≈õƒá pozycji: <b id="total-qty">0</b></span>
        <span class="pill">Razem: <b id="total-sum">0,00 z≈Ç</b></span>
      </div>

      <div style="margin-top:12px; text-align:center;">
        <button id="btn-add-custom-bottom" class="btn primary" type="button">‚ûï Dodaj w≈ÇasnƒÖ pozycjƒô (do wyceny)</button>
      </div>
    </div>

    <!-- Wysy≈Çka -->
    <div class="card">
      <h3>Wysy≈Çka</h3>
      <div class="row-grid">
        <input id="dest-phone" value="48791412017" placeholder="Numer do WhatsApp/SMS (np. 48600111222)" inputmode="tel" />
      </div>
      <div class="mini" style="margin-top:6px;">Numer w formacie miƒôdzynarodowym, bez spacji.</div>
    </div>

    <!-- Podsumowanie + Actions under it -->
    <div class="card">
      <h3>Podsumowanie</h3>
      <div class="summary" id="summary"></div>
      <div class="actions">
        <button class="btn" id="btn-copy" type="button">Kopiuj</button>
        <button class="btn" id="btn-csv" type="button">CSV</button>
        <a class="btn" id="btn-email" href="#">E-mail</a>
        <a class="btn primary" id="btn-wa" href="#" target="_blank">WhatsApp</a>
        <a class="btn" id="btn-sms" href="#">SMS</a>
        <button class="btn ghost" id="btn-clear" type="button">Wyczy≈õƒá</button>
      </div>
    </div>
  </div>

  <!-- Modal: w≈Çasna pozycja (HIDDEN UNTIL OPENED) -->
  <div class="modal-backdrop" id="modal-custom" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <h4 id="modal-title">Dodaj w≈ÇasnƒÖ pozycjƒô (do wyceny)</h4>
      <div class="grid">
        <div style="grid-column:1/-1">
          <label for="custom-name" class="field-note">Nazwa (wymagane, 3‚Äì60 znak√≥w)</label>
          <input id="custom-name" maxlength="60" placeholder="np. Szynka specjalna" />
        </div>
        <div>
          <label for="custom-qty" class="field-note">Ilo≈õƒá (wymagane, &gt; 0)</label>
          <input id="custom-qty" type="number" step="0.01" inputmode="decimal" placeholder="np. 1" />
        </div>
        <div>
          <label for="custom-unit" class="field-note">Jednostka</label>
          <select id="custom-unit">
            <option value="kg">kg</option>
            <option value="szt">szt</option>
          </select>
        </div>
        <div style="grid-column:1/-1">
          <label for="custom-notes" class="field-note">Uwagi (opcjonalnie)</label>
          <input id="custom-notes" placeholder="np. grubo mielone, lekko pikantne" />
        </div>
      </div>
      <div class="actions" style="margin-top:10px; justify-content:flex-end; display:flex;">
        <button class="btn ghost" id="custom-cancel" type="button">Anuluj</button>
        <button class="btn primary" id="custom-save" type="button">Dodaj pozycjƒô</button>
      </div>
    </div>
  </div>

<script>
/* JS identyczny jak w Twoim pliku ‚Äî bez zmian funkcjonalnych */
const VAC_PRICE = 1.5;
const KG_STEP = 0.5; // skok dla kg
const PRICES = {
  'Szynka wƒôdzona': { value: 47, unit: 'kg' },
  'Schab wƒôdzony': { value: 47, unit: 'kg' },
  'Boczek wƒôdzony': { value: 47, unit: 'kg' },
  'Karczek wƒôdzony': { value: 47, unit: 'kg' },
  'Kie≈Çbasa bia≈Ça parzona': { value: 35, unit: 'kg' },
  'Kie≈Çbasa wƒôdzona': { value: 37, unit: 'kg' },
  'Polƒôdwiczka wieprzowa': { value: 25, unit: 'szt' },
  'Pasztet': { value: 20, unit: 'szt' },
  'Salceson': { value: 35, unit: 'kg' },
  'Ser bez przypraw': { value: 10, unit: 'szt' },
  'Ser z czarnuszkƒÖ': { value: 10, unit: 'szt' },
  'Ser z pomidorami i bazyliƒÖ': { value: 10, unit: 'szt' },
  'Ser z czosnkiem': { value: 10, unit: 'szt' },
  'Ser z przyprawƒÖ curry': { value: 10, unit: 'szt' },
  'Ser z chilli': { value: 10, unit: 'szt' },
  'Makrela wƒôdzona': { value: 22, unit: 'szt' },
  '≈öled≈∫ wƒôdzony': { value: 20, unit: 'szt' },
  '≈Åoso≈õ wƒôdzony': { value: 55, unit: 'kg' },
  'Krupniok (kaszanka)': { value: 18, unit: 'kg' },
  'Indyk': { value: 55, unit: 'kg' }
};
const BASE_PRODUCTS = Object.keys(PRICES).map((name) => {
  const p = PRICES[name];
  return { id: 'p-' + name.toLowerCase().replace(/[^a-z0-9]+/g,'-'), name, unit: p.unit, price: p.value, pack:false, qty: 0, notes:'' };
});

// === STAN ===
let state = { rows: [], filter: '' };

function loadState(){
  try{
    const s = JSON.parse(localStorage.getItem('wd-state-v3')||'null');
    if(s && Array.isArray(s.rows)){
      // migruj dope≈Çnienie o Indyk je≈õli brak
      const names = new Set(s.rows.map(r => r.name));
      state.rows = s.rows;
      if(!names.has('Indyk')) state.rows.push({ id: 'p-indyk', name: 'Indyk', unit: 'kg', price: 55, pack:false, qty: 0, notes:'' });
    } else {
      state.rows = [...BASE_PRODUCTS];
    }
    state.filter = s?.filter || '';
  }catch(e){ state.rows = [...BASE_PRODUCTS]; }
}
function saveState(){ localStorage.setItem('wd-state-v3', JSON.stringify({ rows: state.rows, filter: state.filter })); }
function saveAndRender(){ saveState(); render(); }

// === ELEMENTY ===
const listEl = document.getElementById('product-list');
const totalQtyEl = document.getElementById('total-qty');
const totalSumEl = document.getElementById('total-sum');
const summaryEl = document.getElementById('summary');

function formatPrice(v){ return (v||0).toFixed(2).replace('.', ',') + ' z≈Ç'; }
function parseQty(val){ return Math.max(0, parseFloat((''+val).replace(',', '.')) || 0); }

function makeTile(row){
  const el = document.createElement('div');
  el.className = 'tile';

  const head = document.createElement('div');
  head.className = 'tile-head';

  const nameWrap = document.createElement('div');
  nameWrap.className = 'name';
  const title = document.createElement('span');
  title.textContent = row.name;
  nameWrap.appendChild(title);
  if(!(typeof row.price === 'number' && row.price>0)){
    const badge = document.createElement('span');
    badge.className = 'badge';
    badge.innerHTML = '<span class="dot"></span> DO WYCENY';
    nameWrap.appendChild(badge);
  }
  const price = document.createElement('div');
  price.className = 'price';
  price.textContent = (typeof row.price === 'number' && row.price>0) ? (row.price + ' z≈Ç/' + row.unit) : '‚Äî';

  head.appendChild(nameWrap);
  head.appendChild(price);

  const body = document.createElement('div');
  body.className = 'tile-body';

  // Stepper ilo≈õci
  const stepper = document.createElement('div');
  stepper.className = 'stepper';
  const minus = document.createElement('button');
  minus.type = 'button'; minus.textContent = '‚Äì';
  const qty = document.createElement('input');
  qty.type = 'number'; qty.step = '0.01';
  qty.placeholder = row.unit==='kg'?'kg':'szt'; qty.value = row.qty>0?row.qty:'';
  const plus = document.createElement('button');
  plus.type = 'button'; plus.textContent = '+';

  function updateQty(v){
    const step = row.unit==='kg' ? KG_STEP : 1;
    // snap do wielokrotno≈õci kroku
    const snapped = Math.round(v/step)*step;
    row.qty = Math.max(0, +(snapped.toFixed(2)));
    qty.value = row.qty || '';
    saveAndRender();
  }
  minus.addEventListener('click', ()=> updateQty(parseQty(qty.value||0) - (row.unit==='kg'?KG_STEP:1)));
  plus.addEventListener('click', ()=> updateQty(parseQty(qty.value||0) + (row.unit==='kg'?KG_STEP:1)));
  qty.addEventListener('input', ()=>{ row.qty = parseQty(qty.value); saveAndRender(); });

  stepper.appendChild(minus); stepper.appendChild(qty); stepper.appendChild(plus);

  // Switch pakowania + uwagi
  const grid = document.createElement('div');
  grid.className = 'row-grid';

  const packWrap = document.createElement('label');
  packWrap.className = 'switch';
  const packInput = document.createElement('input'); packInput.type='checkbox'; packInput.checked=!!row.pack;
  const track = document.createElement('span'); track.className='track';
  const thumb = document.createElement('span'); thumb.className='thumb';
  track.appendChild(thumb);
  packInput.addEventListener('change', ()=>{ row.pack = packInput.checked; saveAndRender(); });
  const packText = document.createElement('span'); packText.className='mini'; packText.textContent = 'Pakowanie pr√≥≈ºniowe (+1,50 z≈Ç)';
  packWrap.appendChild(packInput); packWrap.appendChild(track); packWrap.appendChild(packText);

  const notes = document.createElement('input');
  notes.placeholder = 'Uwagi (opcjonalnie)';
  notes.value = row.notes || '';
  notes.addEventListener('input', ()=>{ row.notes = notes.value; saveState(); });

  grid.appendChild(packWrap);
  grid.appendChild(notes);

  body.appendChild(stepper);
  body.appendChild(grid);

  el.appendChild(head);
  el.appendChild(body);
  return el;
}

function render(){
  const q = (state.filter||'').trim().toLowerCase();
  const rows = state.rows.filter(r => !q || r.name.toLowerCase().includes(q));

  listEl.innerHTML = '';
  rows.forEach(r => listEl.appendChild(makeTile(r)));

  // Sumy
  let totalQty = 0, total = 0, vacCount = 0;
  const ordered = state.rows.filter(r => r.qty > 0);
  ordered.forEach(r => {
    totalQty += r.qty;
    if(typeof r.price === 'number' && r.price > 0) total += r.qty * r.price;
    if(r.pack) vacCount += 1;
  });
  const vacCost = vacCount * VAC_PRICE;
  const grand = total + vacCost;

  totalQtyEl.textContent = (Math.round(totalQty*100)/100).toString().replace('.', ',');
  totalSumEl.textContent = formatPrice(grand);

  // Podsumowanie
  const lines = [];
  const custName = (document.getElementById('cust-name').value||'').trim();
  const custPhone = (document.getElementById('cust-phone').value||'').trim();
  const custEmail = (document.getElementById('cust-email').value||'').trim();
  const custDate = (document.getElementById('cust-date').value||'').trim();
  const custNotes = (document.getElementById('cust-notes').value||'').trim();

  if(custName) lines.push('Klient: ' + custName);
  if(custPhone) lines.push('Telefon: ' + custPhone);
  if(custEmail) lines.push('E-mail: ' + custEmail);
  if(custDate) lines.push('Data odbioru: ' + custDate);
  if(custNotes) lines.push('Uwagi: ' + custNotes);
  if(lines.length) lines.push('');

  lines.push('Zam√≥wienie:');
  if(ordered.length === 0){
    lines.push('‚Äî (brak pozycji)');
  } else {
    ordered.forEach(r => {
      const base = `${r.name}: ${r.qty} ${r.unit}`;
      const priceInfo = (typeof r.price === 'number' && r.price > 0) ? ` @ ${r.price} z≈Ç/${r.unit}` : ' (do wyceny)';
      const bits = [base + priceInfo];
      if(r.pack) bits.push('[pakowanie +1,50 z≈Ç]');
      if(r.notes) bits.push(`[uwagi: ${r.notes}]`);
      lines.push('‚Ä¢ ' + bits.join(' '));
    });
  }
  lines.push('');
  lines.push(`Suma produkt√≥w: ${formatPrice(total)}`);
  lines.push(`Pakowanie: ${vacCount} √ó ${formatPrice(VAC_PRICE)} = ${formatPrice(vacCost)}`);
  lines.push(`RAZEM: ${formatPrice(grand)}`);

  summaryEl.textContent = lines.join('\n');
}

// === Wyszukiwarka ===
document.getElementById('search').addEventListener('input', (e)=>{
  state.filter = e.target.value;
  saveAndRender();
});

// === Pakowanie zbiorcze ===
document.getElementById('btn-pack-all').addEventListener('click', ()=>{
  state.rows.forEach(r => { if(r.qty > 0) r.pack = true; });
  saveAndRender();
});
document.getElementById('btn-pack-clear').addEventListener('click', ()=>{
  state.rows.forEach(r => { r.pack = false; });
  saveAndRender();
});

// === Export / udostƒôpnianie ===
function getSummaryText(){ return document.getElementById('summary').textContent; }
function encodeText(t){ return encodeURIComponent(t).replace(/%20/g,'+'); }
function prepMessage(){ return getSummaryText(); }

document.getElementById('btn-copy').addEventListener('click', async ()=>{
  try{ await navigator.clipboard.writeText(getSummaryText()); alert('Skopiowano podsumowanie do schowka.'); }
  catch(e){ alert('Nie uda≈Ço siƒô skopiowaƒá. Skopiuj rƒôcznie z sekcji Podsumowanie.'); }
});

document.getElementById('btn-csv').addEventListener('click', ()=>{
  const rows = [['Nazwa','Ilo≈õƒá','Jednostka','Cena jednostkowa','Pakowanie','Uwagi']];
  state.rows.filter(r => r.qty > 0).forEach(r => {
    rows.push([
      r.name,
      String(r.qty).replace('.',','),
      r.unit,
      (typeof r.price === 'number' && r.price > 0) ? (String(r.price).replace('.',',')+' z≈Ç/'+r.unit) : 'do wyceny',
      r.pack ? 'tak' : 'nie',
      r.notes || ''
    ]);
  });
  const csv = rows.map(r => r.map(v => '"'+String(v).replaceAll('"','""')+'"').join(';')).join('\r\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'zamowienie.csv';
  document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
});

document.getElementById('btn-email').addEventListener('click', (e)=>{
  const subject = 'Zam√≥wienie ‚Äî Wƒôdliny z Druciarni';
  const body = prepMessage();
  e.currentTarget.href = 'mailto:?subject=' + encodeText(subject) + '&body=' + encodeText(body);
});

document.getElementById('btn-wa').addEventListener('click', (e)=>{
  const num = (document.getElementById('dest-phone').value||'').replace(/\D+/g,'');
  const text = prepMessage();
  e.currentTarget.href = 'https://wa.me/' + num + '?text=' + encodeText(text);
});

document.getElementById('btn-sms').addEventListener('click', (e)=>{
  const num = (document.getElementById('dest-phone').value||'').replace(/\D+/g,'');
  const text = prepMessage();
  e.currentTarget.href = 'sms:' + num + '?&body=' + encodeText(text);
});

document.getElementById('btn-clear').addEventListener('click', ()=>{
  if(!confirm('Na pewno wyczy≈õciƒá formularz?')) return;
  localStorage.removeItem('wd-state-v3');
  state.rows = [...BASE_PRODUCTS];
  document.getElementById('cust-name').value = '';
  document.getElementById('cust-phone').value = '';
  document.getElementById('cust-email').value = '';
  document.getElementById('cust-date').value = '';
  document.getElementById('cust-notes').value = '';
  render();
});

// === Modal w≈Çasna pozycja ===
function openCustomModal(){ modal.open(); }
const modal = {
  el: document.getElementById('modal-custom'),
  name: null, qty: null, unit: null, notes: null,
  open(){
    this.name = document.getElementById('custom-name');
    this.qty = document.getElementById('custom-qty');
    this.unit = document.getElementById('custom-unit');
    this.notes = document.getElementById('custom-notes');
    this.name.value = '';
    this.qty.value = '';
    this.unit.value = 'kg';
    this.notes.value = '';
    this.clearErrors();
    this.el.style.display = 'flex';
    this.el.setAttribute('aria-hidden','false');
    setTimeout(()=> this.name.focus(), 0);
  },
  close(){
    this.el.style.display = 'none';
    this.el.setAttribute('aria-hidden','true');
  },
  clearErrors(){ [this.name,this.qty].forEach(i=> i && i.classList.remove('error')); },
  validate(){
    this.clearErrors();
    const n = (this.name.value||'').trim();
    const q = parseFloat((this.qty.value||'').replace(',', '.'));
    let ok = true;
    if (n.length < 3 || n.length > 60){ this.name.classList.add('error'); ok = false; }
    if (!(q > 0)){ this.qty.classList.add('error'); ok = false; }
    return ok ? { name:n, qty:q, unit:this.unit.value, notes:(this.notes.value||'').trim() } : null;
  }
};
function closeCustomModal(){ modal.close(); }
document.getElementById('custom-cancel').addEventListener('click', closeCustomModal);
document.getElementById('modal-custom').addEventListener('click', (e)=>{
  if (e.target === document.getElementById('modal-custom')) closeCustomModal();
});
document.getElementById('custom-save').addEventListener('click', ()=>{
  const data = modal.validate(); if (!data) return;
  const id = 'custom-' + Date.now().toString(36);
  state.rows.push({ id, name: data.name, qty: data.qty, unit: data.unit, price: undefined, pack:false, notes:data.notes });
  saveAndRender(); closeCustomModal();
});
document.getElementById('btn-add-custom-bottom').addEventListener('click', openCustomModal);

// === Init ===
loadState();
render();

// Aktualizacje na zmiany klienta
['cust-name','cust-phone','cust-email','cust-date','cust-notes'].forEach(id=>{
  const el = document.getElementById(id);
  el.addEventListener('input', ()=> { saveState(); render(); });
});
</script>
</body>
</html>
